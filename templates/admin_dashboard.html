<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONTROL PANEL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Arial', sans-serif;
        }
        h1 {
            text-align: center;
            margin-top: 30px;
            color: #e0e0e0;
            font-weight: 600;
        }

        .card {
            background-color: #1f1f1f;
            border: none;
            border-radius: 10px;
            margin: 20px auto;
            padding: 15px; /* Reduced padding */
            max-width: 500px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            animation: fadeInUp 0.6s ease-in-out;
        }

        .form-control, .btn {
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn {
            padding: 8px 16px;
            font-weight: 400;
            transition: all 0.2s ease-in-out;
            width: 100%;
            height: 40px;
            font-size: 0.9rem;
        }

        .form-control {
            background-color: #2c2c2c;
            color: #e0e0e0;
            border: 1px solid #444;
            height: 45px;
        }

        .form-control:focus {
            background-color: #2c2c2c;
            color: #ffffff;
            border-color: #8ab4f8;
            box-shadow: none;
        }

        .btn-primary { background-color: #0d6efd; }
        .btn-success { background-color: #198754; }
        .btn-warning { background-color: #ffc107; }
        .btn-danger  { background-color: #dc3545; }

        .btn-primary:hover { background-color: #0b5ed7; }
        .btn-success:hover { background-color: #157347; }
        .btn-warning:hover { background-color: #ffca2c; }
        .btn-danger:hover  { background-color: #bb2d3b; }

        .btn i { margin-right: 8px; }

        #resultMessage .alert {
            max-width: 500px;
            margin: 0 auto;
        }

        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(40px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* Lockdown button states */
        .lockdown-on {
            background-color: #198754 !important;
            border-color: #157347 !important;
        }
        .lockdown-off {
            background-color: #dc3545 !important;
            border-color: #bb2d3b !important;
        }
        
        input[type="file"] {
            display: block;
            position: relative;
            margin-top: 10px;
            color: #e0e0e0;
        }

        .download-section {
            margin-top: 20px;
        }

        ::placeholder {
            color: #e0e0e0 !important;
            opacity: 1;
        }

        :-ms-input-placeholder {
            color: #e0e0e0 !important;
        }

        ::-ms-input-placeholder {
            color: #e0e0e0 !important;
        }
        
        input[type="file"].form-control {
            height: 38px;
            padding: 6px 12px;
            line-height: 1.5;
            cursor: pointer;
        }

        .card form .mb-3 {
            margin-bottom: 0.75rem;
        }

        .form-label {
            margin-bottom: 0.25rem;
            font-size: 0.9em;
        }
       /* Freemode button states */
.freemode-on {
    background-color: #198754 !important;
    border-color: #157347 !important;
}
.freemode-off {
    background-color: #dc3545 !important;
    border-color: #bb2d3b !important;
}

.storage-card {
    padding: 10px; /* Reduce padding */
    margin: 5px auto; /* Reduce margin */
}

.storage-card .card-body {
    padding: 10px; /* Reduce inner padding */
}

.storage-card h5 {
    font-size: 1rem; /* Reduce title size */
    margin-bottom: 5px; /* Reduce bottom margin */
}

.storage-card .progress {
    height: 15px; /* Reduce progress bar height */
}

.storage-card p {
    font-size: 0.85rem; /* Reduce text size */
    margin-top: 5px; /* Reduce spacing */
}
.storage-card {
    margin-bottom: 15px; /* Add spacing between cards */
}
.progress {
    background-color: #2c2c2c;
    border-radius: 10px;
}

/* Error message styling */
.storage-error {
    color: #dc3545 !important;
    font-size: 0.9rem;
    margin-top: 5px;
}
.proxy-on {
    background-color: #198754 !important;
    border-color: #157347 !important;
}
.proxy-off {
    background-color: #dc3545 !important;
    border-color: #bb2d3b !important;
}
.metric-card {
    background-color: #2d2d2d !important;
    border: 1px solid #444;
    transition: transform 0.2s;
}
.metric-card:hover {
    transform: translateY(-3px);
}

/* Add to existing button states */
.performance-on {
    background-color: #198754 !important;
    border-color: #157347 !important;
}
.performance-off {
    background-color: #dc3545 !important;
    border-color: #bb2d3b !important;
}
    </style>
</head>
<body>
    <h1>CONTROL PANEL</h1>
    <!-- IMDb Fetch Form -->
    <div class="card shadow-sm">
        <form action="/fetch" method="POST">
            <input type="text" id="imdb_id" name="imdb_id" class="form-control mb-3" 
                   placeholder="e.g., tt1234567" required>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i> Fetch Data
            </button>
        </form>
    </div>

    <!-- Storage Cards -->
    <div class="card storage-card shadow-sm text-center">
        <div class="card-body">
            <h5 class="card-title"><i class="fas fa-hdd"></i> Server 1 Storage</h5>
            <div class="progress mt-3" style="height: 20px;">
                <div id="storageBar1" class="progress-bar bg-success" role="progressbar" 
                     style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    0%
                </div>
            </div>
            <p id="storageStatus1" class="mt-2 text-light">Fetching storage info...</p>
        </div>
    </div>

    <div class="card storage-card shadow-sm text-center">
        <div class="card-body">
            <h5 class="card-title"><i class="fas fa-hdd"></i> Server 2 Storage</h5>
            <div class="progress mt-3" style="height: 20px;">
                <div id="storageBar2" class="progress-bar bg-warning" role="progressbar" 
                     style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    0%
                </div>
            </div>
            <p id="storageStatus2" class="mt-2 text-light">Fetching storage info...</p>
        </div>
    </div>

    <!-- Upload and Download Forms -->
    <div class="card shadow-sm mt-3">
        <form action="/upload_data" method="POST" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="data_file" class="form-label">Upload data.db:</label>
                <input type="file" id="data_file" name="data_file" 
                       accept=".db" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-warning">
                <i class="fas fa-upload"></i> Upload data.db
            </button>
        </form>
    </div>

    <div class="card shadow-sm mt-3">
        <form action="/upload_user_token" method="POST" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="user_token" class="form-label">Upload user_token.json:</label>
                <input type="file" id="user_token" name="user_token" 
                       accept=".json" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-warning">
                <i class="fas fa-upload"></i> Upload user_token.json
            </button>
        </form>
    </div>
    
    <div class="card shadow-sm mt-3">
        <form action="/upload_user_token2" method="POST" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="user_token2" class="form-label">Upload user_token2.json:</label>
                <input type="file" id="user_token2" name="user_token2" 
                       accept=".json" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-warning">
                <i class="fas fa-upload"></i> Upload user_token.json2
            </button>
        </form>
    </div>
    
    <div class="card shadow-sm mt-3 download-section">
        <div class="d-grid gap-2">
            <form action="/download_data" method="GET">
                <button type="submit" class="btn btn-success mb-2">
                    <i class="fas fa-download"></i> Download data.db
                </button>
            </form>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="card shadow-sm mt-3">
        <div class="d-grid gap-2">
            <button id="replaceBackupBtn" class="btn btn-danger">
                <i class="fas fa-sync-alt"></i> Replace with Latest Backup
            </button>
        </div>
    </div>

    <div class="card shadow-sm mt-3">
        <div class="d-grid gap-2">
            <a href="/admin/edit" class="btn btn-primary">
                <i class="fas fa-edit"></i> Open Editor
            </a>
        </div>
    </div>

    <div class="card shadow-sm mt-3">
        <div class="d-grid gap-2">
            <button id="lockdownToggleBtn" class="btn lockdown-off">
                <i class="fas fa-toggle-off"></i> Turn On Lockdown
            </button>
        </div>
    </div>
    
    <div class="card shadow-sm mt-3">
        <div class="d-grid gap-2">
            <button id="freemodeToggleBtn" class="btn freemode-off">
                <i class="fas fa-toggle-off"></i> Turn On Free Mode
            </button>
        </div>
    </div>
<!-- Add this card after the Free Mode button -->
<div class="card shadow-sm mt-3">
    <div class="d-grid gap-2">
        <button id="proxyToggleBtn" class="btn proxy-off">
            <i class="fas fa-toggle-off"></i> Enable Proxy URLs
        </button>
    </div>
</div>

<div class="card shadow-sm mt-3">
    <div class="d-grid gap-2">
        <button id="performanceToggleBtn" class="btn performance-off">
            <i class="fas fa-toggle-off"></i> Enable Performance Meter
        </button>
    </div>
</div>

    <div class="card shadow-sm mt-3" id="performanceMeterCard" style="display: none;">
        <div class="card-body">
            <h5 class="card-title"><i class="fas fa-gauge-high"></i> System Performance</h5>
            <div class="row mt-3">
                <div class="col-md-3 mb-3">
                    <div class="metric-card bg-dark p-3 rounded">
                        <div class="d-flex justify-content-between">
                            <span>CPU Usage</span>
                            <span id="cpuMetric">0%</span>
                        </div>
                        <div class="progress mt-2" style="height: 8px;">
                            <div id="cpuProgress" class="progress-bar bg-info" role="progressbar"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="metric-card bg-dark p-3 rounded">
                        <div class="d-flex justify-content-between">
                            <span>Memory Usage</span>
                            <span id="memMetric">0%</span>
                        </div>
                        <div class="progress mt-2" style="height: 8px;">
                            <div id="memProgress" class="progress-bar bg-success" role="progressbar"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="metric-card bg-dark p-3 rounded">
                        <div class="d-flex justify-content-between">
                            <span>Upload Speed</span>
                            <span id="uploadMetric">0 MB/s</span>
                        </div>
                        <div class="progress mt-2" style="height: 8px;">
                            <div id="uploadProgress" class="progress-bar bg-warning" role="progressbar"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="metric-card bg-dark p-3 rounded">
                        <div class="d-flex justify-content-between">
                            <span>Download Speed</span>
                            <span id="downloadMetric">0 MB/s</span>
                        </div>
                        <div class="progress mt-2" style="height: 8px;">
                            <div id="downloadProgress" class="progress-bar bg-danger" role="progressbar"></div>
                        </div>
                    </div>
                </div>
            </div>
            <canvas id="performanceChart" style="max-height: 250px;"></canvas>
        </div>
    </div>
    
    <!-- Add after proxy toggle button -->

    <!-- Result Message Display -->
    <div id="resultMessage" class="text-center mt-3"></div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Replace Backup Handler
        document.getElementById("replaceBackupBtn").addEventListener("click", async function() {
            const resultMessage = document.getElementById("resultMessage");
            resultMessage.innerHTML = "";

            try {
                const response = await fetch("/replace_backup", { method: "POST" });
                const result = await response.json();
                
                const alertType = response.ok ? "success" : "danger";
                resultMessage.innerHTML = `
                    <div class="alert alert-${alertType}">${result.message}</div>
                `;
            } catch (error) {
                resultMessage.innerHTML = `
                    <div class="alert alert-danger">Failed to replace backup</div>
                `;
            }
        });

        // Lockdown Toggle Handler
        document.getElementById("lockdownToggleBtn").addEventListener("click", async function () {
            const resultMessage = document.getElementById("resultMessage");
            resultMessage.innerHTML = "";

            try {
                const response = await fetch("/toggle_lockdown", { method: "POST" });
                const result = await response.json();

                if (response.ok) {
                    const currentState = result.lockdown;
                    if (currentState === "on") {
                        this.classList.remove("lockdown-off");
                        this.classList.add("lockdown-on");
                        this.innerHTML = `<i class="fas fa-toggle-on"></i> Turn Off Lockdown`;
                    } else {
                        this.classList.remove("lockdown-on");
                        this.classList.add("lockdown-off");
                        this.innerHTML = `<i class="fas fa-toggle-off"></i> Turn On Lockdown`;
                    }
                    resultMessage.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                } else {
                    resultMessage.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
                }
            } catch (error) {
                resultMessage.innerHTML = `<div class="alert alert-danger">Failed to toggle lockdown. Please try again.</div>`;
            }
        });

        // Initialize lockdown state on page load
        (async function initializeLockdownState() {
            try {
                const response = await fetch("/lockdown_status");
                const result = await response.json();

                if (response.ok) {
                    const button = document.getElementById("lockdownToggleBtn");
                    const currentState = result.lockdown;
                    if (currentState === "on") {
                        button.classList.add("lockdown-on");
                        button.classList.remove("lockdown-off");
                        button.innerHTML = `<i class="fas fa-toggle-on"></i> Turn Off Lockdown`;
                    } else {
                        button.classList.add("lockdown-off");
                        button.classList.remove("lockdown-on");
                        button.innerHTML = `<i class="fas fa-toggle-off"></i> Turn On Lockdown`;
                    }
                }
            } catch (error) {
                console.error("Error initializing lockdown state:", error);
            }
        })();

        // Freemode Toggle Handler
        document.getElementById("freemodeToggleBtn").addEventListener("click", async function () {
            const resultMessage = document.getElementById("resultMessage");
            resultMessage.innerHTML = "";

            try {
                const response = await fetch("/toggle_freemode", { method: "POST" });
                const result = await response.json();

                if (response.ok) {
                    const currentState = result.freemode;
                    if (currentState === "on") {
                        this.classList.remove("freemode-off");
                        this.classList.add("freemode-on");
                        this.innerHTML = `<i class="fas fa-toggle-on"></i> Turn Off Free Mode`;
                    } else {
                        this.classList.remove("freemode-on");
                        this.classList.add("freemode-off");
                        this.innerHTML = `<i class="fas fa-toggle-off"></i> Turn On Free Mode`;
                    }
                    resultMessage.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                } else {
                    resultMessage.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
                }
            } catch (error) {
                resultMessage.innerHTML = `<div class="alert alert-danger">Failed to toggle free mode. Please try again.</div>`;
            }
        });

        // Initialize freemode state on page load
        (async function initializeFreemodeState() {
            try {
                const response = await fetch("/freemode_status");
                const result = await response.json();

                if (response.ok) {
                    const button = document.getElementById("freemodeToggleBtn");
                    const currentState = result.freemode;
                    if (currentState === "on") {
                        button.classList.add("freemode-on");
                        button.classList.remove("freemode-off");
                        button.innerHTML = `<i class="fas fa-toggle-on"></i> Turn Off Free Mode`;
                    } else {
                        button.classList.add("freemode-off");
                        button.classList.remove("freemode-on");
                        button.innerHTML = `<i class="fas fa-toggle-off"></i> Turn On Free Mode`;
                    }
                }
            } catch (error) {
                console.error("Error initializing freemode state:", error);
            }
        })();

        async function updateStorageStatus() {
            try {
                // Fetch Server 1 storage info
                const response1 = await fetch('/get_storage_info?server=1');
                const data1 = await response1.json();
                updateStorageUI(1, data1);

                // Fetch Server 2 storage info
                const response2 = await fetch('/get_storage_info?server=2');
                const data2 = await response2.json();
                updateStorageUI(2, data2);
            } catch (error) {
                console.error("Failed to fetch storage info:", error);
            }
        }

        function formatStorage(usedBytes, totalBytes) {
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let unitIndex = 0;

            // Determine the largest unit for the total
            let tempTotal = totalBytes;
            while (tempTotal >= 1024 && unitIndex < units.length - 1) {
                tempTotal /= 1024;
                unitIndex++;
            }

            // Convert both used and total to the determined unit
            const used = usedBytes / Math.pow(1024, unitIndex);
            const total = totalBytes / Math.pow(1024, unitIndex);
            
            return {
                used: used.toFixed(2),
                total: total.toFixed(2),
                unit: units[unitIndex]
            };
        }

        function updateStorageUI(serverNumber, data) {
    const resultElement = document.getElementById(`storageStatus${serverNumber}`);
    const barElement = document.getElementById(`storageBar${serverNumber}`);

    // Reset classes
    resultElement.classList.remove('storage-error', 'text-light');
    resultElement.classList.add('text-light');

    if (data.used_bytes && data.total_bytes) {
        const used = parseFloat(data.used_bytes);
        const total = parseFloat(data.total_bytes);
        const percentage = ((used / total) * 100).toFixed(1);

        // Format storage values
        const formatted = formatStorage(used, total);
        resultElement.innerHTML = `<i class="fas fa-circle text-success"></i> ${formatted.used} ${formatted.unit} / ${formatted.total} ${formatted.unit}`;
        
        // Update progress bar
        barElement.style.width = `${percentage}%`;
        barElement.textContent = `${percentage}%`;
        
        // Update bar color
        barElement.className = 'progress-bar';
        if (percentage > 90) barElement.classList.add('bg-danger');
        else if (percentage > 70) barElement.classList.add('bg-warning');
        else barElement.classList.add('bg-success');
    } else {
        resultElement.classList.remove('text-light');
        resultElement.classList.add('storage-error');
        resultElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error fetching storage data`;
        
        barElement.className = 'progress-bar bg-danger';
        barElement.style.width = '100%';
        barElement.textContent = 'Error';
    }
}

        // Call function on page load
        updateStorageStatus();
        
        
        // Add to existing script
document.getElementById("proxyToggleBtn").addEventListener("click", async function () {
    const resultMessage = document.getElementById("resultMessage");
    resultMessage.innerHTML = "";

    try {
        const response = await fetch("/toggle_proxy", { method: "POST" });
        const result = await response.json();

        if (response.ok) {
            const currentState = result.enabled;
            if (currentState) {
                this.classList.remove("proxy-off");
                this.classList.add("proxy-on");
                this.innerHTML = `<i class="fas fa-toggle-on"></i> Disable Proxy URLs`;
            } else {
                this.classList.remove("proxy-on");
                this.classList.add("proxy-off");
                this.innerHTML = `<i class="fas fa-toggle-off"></i> Enable Proxy URLs`;
            }
            resultMessage.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
        } else {
            resultMessage.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
        }
    } catch (error) {
        resultMessage.innerHTML = `<div class="alert alert-danger">Failed to toggle proxy. Please try again.</div>`;
    }
});

// Initialize proxy state
(async function initializeProxyState() {
    try {
        const response = await fetch("/proxy_status");
        const result = await response.json();

        if (response.ok) {
            const button = document.getElementById("proxyToggleBtn");
            const currentState = result.enabled;
            if (currentState) {
                button.classList.add("proxy-on");
                button.classList.remove("proxy-off");
                button.innerHTML = `<i class="fas fa-toggle-on"></i> Disable Proxy URLs`;
            } else {
                button.classList.add("proxy-off");
                button.classList.remove("proxy-on");
                button.innerHTML = `<i class="fas fa-toggle-off"></i> Enable Proxy URLs`;
            }
        }
    } catch (error) {
        console.error("Error initializing proxy state:", error);
    }
})();

// Performance Chart and Metrics Handling
let performanceChart = null;
let performanceInterval = null;
let maxNetworkSpeed = 1;

function initializeChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (performanceChart) {
        performanceChart.destroy();
    }

    performanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'CPU Usage (%)',
                    data: [],
                    borderColor: '#0dcaf0',
                    tension: 0.4
                },
                {
                    label: 'Memory Usage (%)',
                    data: [],
                    borderColor: '#198754',
                    tension: 0.4
                },
                {
                    label: 'Upload Speed (MB/s)',
                    data: [],
                    borderColor: '#ffc107',
                    tension: 0.4,
                    yAxisID: 'y-network'
                },
                {
                    label: 'Download Speed (MB/s)',
                    data: [],
                    borderColor: '#dc3545',
                    tension: 0.4,
                    yAxisID: 'y-network'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: { color: '#333' },
                    title: { text: 'CPU/Memory %', color: '#fff' },
                    ticks: { color: '#fff' }
                },
                'y-network': {
                    position: 'right',
                    title: { text: 'Network (MB/s)', color: '#fff' },
                    grid: { drawOnChartArea: false, color: '#333' },
                    ticks: { color: '#fff' }
                },
                x: { 
                    grid: { color: '#333' },
                    ticks: { color: '#fff' }
                }
            },
            plugins: {
                legend: { labels: { color: '#fff' } }
            }
        }
    });
}

async function updatePerformanceMetrics() {
    try {
        const response = await fetch('/performance_metrics');
        const data = await response.json();
        
        // Update metrics
        document.getElementById('cpuMetric').textContent = `${data.cpu}%`;
        document.getElementById('cpuProgress').style.width = `${data.cpu}%`;
        document.getElementById('memMetric').textContent = `${data.memory}%`;
        document.getElementById('memProgress').style.width = `${data.memory}%`;
        
        const uploadSpeed = data.network.upload;
        const downloadSpeed = data.network.download;
        document.getElementById('uploadMetric').textContent = `${uploadSpeed.toFixed(1)} MB/s`;
        document.getElementById('downloadMetric').textContent = `${downloadSpeed.toFixed(1)} MB/s`;

        // Update progress bars
        maxNetworkSpeed = Math.max(maxNetworkSpeed, uploadSpeed, downloadSpeed);
        document.getElementById('uploadProgress').style.width = 
            `${(uploadSpeed / maxNetworkSpeed * 100).toFixed(1)}%`;
        document.getElementById('downloadProgress').style.width = 
            `${(downloadSpeed / maxNetworkSpeed * 100).toFixed(1)}%`;

        // Update chart
        if (performanceChart) {
            const time = new Date().toLocaleTimeString();
            if(performanceChart.data.labels.length > 15) {
                performanceChart.data.labels.shift();
                performanceChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            performanceChart.data.labels.push(time);
            performanceChart.data.datasets[0].data.push(data.cpu);
            performanceChart.data.datasets[1].data.push(data.memory);
            performanceChart.data.datasets[2].data.push(uploadSpeed);
            performanceChart.data.datasets[3].data.push(downloadSpeed);
            performanceChart.update();
        }
    } catch (error) {
        console.error('Error fetching metrics:', error);
    }
}

// Performance Meter Toggle Handler
document.getElementById("performanceToggleBtn").addEventListener("click", async function () {
    const resultMessage = document.getElementById("resultMessage");
    resultMessage.innerHTML = "";

    try {
        const response = await fetch("/toggle_performance_meter", { method: "POST" });
        const result = await response.json();

        if (response.ok) {
            const currentState = result.enabled;
            const meterCard = document.getElementById('performanceMeterCard');
            
            if (currentState) {
                // Enable performance meter
                this.classList.remove("performance-off");
                this.classList.add("performance-on");
                this.innerHTML = `<i class="fas fa-toggle-on"></i> Disable Performance Meter`;
                
                // Initialize chart and start updates
                initializeChart();
                if (!performanceInterval) {
                    performanceInterval = setInterval(updatePerformanceMetrics, 2000);
                    updatePerformanceMetrics();
                }
                meterCard.style.display = 'block';
            } else {
                // Disable performance meter
                this.classList.remove("performance-on");
                this.classList.add("performance-off");
                this.innerHTML = `<i class="fas fa-toggle-off"></i> Enable Performance Meter`;
                
                // Clear resources
                clearInterval(performanceInterval);
                performanceInterval = null;
                if (performanceChart) {
                    performanceChart.destroy();
                    performanceChart = null;
                }
                meterCard.style.display = 'none';
            }
            resultMessage.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
        } else {
            resultMessage.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
        }
    } catch (error) {
        resultMessage.innerHTML = `<div class="alert alert-danger">Failed to toggle performance meter. Please try again.</div>`;
    }
});

// Initialize performance state on page load
(async function initializePerformanceState() {
    try {
        const response = await fetch("/performance_meter_status");
        const result = await response.json();
        const button = document.getElementById("performanceToggleBtn");
        const meterCard = document.getElementById('performanceMeterCard');

        if (result.enabled) {
            button.classList.add("performance-on");
            button.classList.remove("performance-off");
            button.innerHTML = `<i class="fas fa-toggle-on"></i> Disable Performance Meter`;
            initializeChart();
            performanceInterval = setInterval(updatePerformanceMetrics, 2000);
            updatePerformanceMetrics();
            meterCard.style.display = 'block';
        } else {
            button.classList.add("performance-off");
            button.classList.remove("performance-on");
            button.innerHTML = `<i class="fas fa-toggle-off"></i> Enable Performance Meter`;
            meterCard.style.display = 'none';
        }
    } catch (error) {
        console.error("Error initializing performance state:", error);
    }
})();
    </script>
</body>
</html>